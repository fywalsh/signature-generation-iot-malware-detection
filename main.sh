#!/bin/bash

INPUT=$1
[ ! -f $INPUT ] && { echo "$INPUT file not found"; exit 99; }

syscall_dataset_dir="/home/datausr/01_DataAnalysis/02_SysCall_Datasets/"

sed 1d $INPUT | while IFS=',', read -r run_num fes_ngram fes_topn mc_tree_depth
do
	start=$(date +%s.%N)
	echo "Run Num: $run_num" 

	EXP_RUN_DIR="/home/datausr/02_Experiments/exp_results_run_num_$run_num/"
	if [ -d "$EXP_RUN_DIR" ]; then rm -Rf $EXP_RUN_DIR; fi
	mkdir $EXP_RUN_DIR

	#1. Perform feature selection
	echo ""
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo "Phase #1 - Performing feature extraction and selection...."
	~/PycharmProjects/MScDissDev/feature_extraction_selection.py -i "$syscall_dataset_dir" -o "$EXP_RUN_DIR" -n "$fes_ngram" -t "$fes_topn"

	#2. Perform classification
	echo ""
	echo ""
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo "Phase #2 - Performing classification...."
	~/PycharmProjects/MScDissDev/malware_classification.py -i "$EXP_RUN_DIR" -o "$EXP_RUN_DIR" -d "$mc_tree_depth"

	#3. Perform malware signature generation
	echo ""
	echo ""
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo "Phase #3 - Performing malware signature generation...."
	~/PycharmProjects/MScDissDev/signature_generator.py -i "$EXP_RUN_DIR" -o "$EXP_RUN_DIR"

	#4. Perform malware detection
	echo ""
	echo ""
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo "Phase #4 - Performing malware detection...."
	~/PycharmProjects/MScDissDev/malware_detection.py -i "$syscall_dataset_dir" -o "$EXP_RUN_DIR" -s "$EXP_RUN_DIR"
	
	duration=$(echo "$(date +%s.%N) - $start" | bc)
	execution_time=$(printf "%.2f seconds" $duration)
	echo ""
	echo "Run Num: $run_num | Execution Time: $execution_time"
done

